{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Farm2Home</title>
    <link rel="stylesheet" href="{% static 'css/global-typography.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/checkout.css' %}">
    <link rel="stylesheet" href="{% static 'css/modal-auth.css' %}">
    <link rel="stylesheet" href="{% static 'css/notifications.css' %}"
</head>
<body>
    <div class="checkout-container">


        <div class="checkout-wrapper">
            <!-- Left Side - Order Items -->
            <div class="order-items-section">
                <button class="back-btn" onclick="goBack()">
                    <i class="fas fa-arrow-left"></i> Back
                </button>
                
                <div class="items-carousel">
                    <div class="carousel-container">
                        <div class="carousel-items" id="carouselItems"></div>
                    </div>
                    <div class="carousel-dots" id="carouselDots"></div>
                    
                    <!-- Navigation Arrows -->
                    <button class="carousel-arrow prev-arrow" onclick="prevCarouselItem()" style="display: none;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="carousel-arrow next-arrow" onclick="nextCarouselItem()" style="display: none;">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Right Side - Checkout Form -->
            <div class="checkout-form-section">
                <!-- Progress Steps -->
                <div class="progress-steps" data-active="1">
                    <div class="step active" id="step1">
                        <span class="step-number">1</span>
                        <span class="step-label">SHIPPING</span>
                    </div>
                    <div class="step" id="step2">
                        <span class="step-number">2</span>
                        <span class="step-label">BILLING</span>
                    </div>
                    <div class="step" id="step3">
                        <span class="step-number">3</span>
                        <span class="step-label">CONFIRMATION</span>
                    </div>
                </div>

                <!-- Shipping Form (Step 1) -->
                <form id="shippingForm" class="checkout-form active-form">
                    <h2>SHIPPING INFORMATION</h2>
                    
                    <!-- Saved Addresses Selector -->
                    <div class="form-group" id="savedAddressGroup" style="display: none;">
                        <label><i class="fas fa-bookmark"></i> USE SAVED ADDRESS</label>
                        <div class="input-wrapper">
                            <i class="fas fa-map-marked-alt"></i>
                            <select id="savedAddresses" onchange="fillAddressFromSaved()">
                                <option value="">-- Select a saved address --</option>
                            </select>
                        </div>
                        <small style="color: rgba(255, 255, 255, 0.7); font-size: 0.875rem; margin-top: 8px; display: block;">
                            Or enter a new address below
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>FULL NAME</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user"></i>
                            <input type="text" id="fullName" placeholder="John Doe" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>EMAIL ADDRESS</label>
                        <div class="input-wrapper">
                            <i class="fas fa-envelope"></i>
                            <input type="email" id="email" placeholder="johndoe@example.com" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>PHONE NUMBER</label>
                        <div class="input-wrapper">
                            <i class="fas fa-phone"></i>
                            <input type="tel" id="phone" placeholder="(555) 123-4567" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>STREET ADDRESS</label>
                        <div class="input-wrapper">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="address" placeholder="123 Farm Road" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>CITY</label>
                            <input type="text" id="city" placeholder="Springfield" required>
                        </div>
                        <div class="form-group">
                            <label>ZIP CODE</label>
                            <input type="text" id="zipCode" placeholder="12345" required>
                        </div>
                    </div>

                    <!-- Delivery Details Box -->
                    <div class="delivery-details">
                        <h3><i class="fas fa-map-pin"></i> DELIVERY DETAILS</h3>
                        <ul>
                            <li><i class="fas fa-check"></i> Same day delivery for your fresh farm products</li>
                            <li><i class="fas fa-check"></i> Free delivery on orders over $50</li>
                            <li><i class="fas fa-check"></i> Fresh from local farms</li>
                        </ul>
                    </div>

                    <button type="button" class="continue-btn" onclick="nextStep()">CONTINUE TO PAYMENT</button>
                </form>

                <!-- Billing Form (Step 2) -->
                <form id="billingForm" class="checkout-form">
                    <h2>BILLING INFORMATION</h2>
                    
                    <div class="form-group">
                        <label>CARD HOLDER NAME</label>
                        <div class="input-wrapper">
                            <i class="fas fa-user"></i>
                            <input type="text" id="cardName" placeholder="John Doe" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>CARD NUMBER</label>
                        <div class="input-wrapper">
                            <i class="fas fa-credit-card"></i>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>EXPIRY DATE</label>
                            <input type="text" id="expiryDate" placeholder="MM/YY" maxlength="5" required>
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" id="cvv" placeholder="123" maxlength="3" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>BILLING ADDRESS</label>
                        <div class="input-wrapper">
                            <i class="fas fa-map-marker-alt"></i>
                            <input type="text" id="billingAddress" placeholder="123 Farm Road" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>CITY</label>
                            <input type="text" id="billingCity" placeholder="Springfield" required>
                        </div>
                        <div class="form-group">
                            <label>ZIP CODE</label>
                            <input type="text" id="billingZip" placeholder="12345" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <button type="button" class="continue-btn back-step" onclick="prevStep()">BACK</button>
                        <button type="button" class="continue-btn" onclick="nextStep()">CONTINUE TO CONFIRMATION</button>
                    </div>
                </form>

                <!-- Confirmation (Step 3) -->
                <div id="confirmationForm" class="checkout-form">
                    <h2>ORDER CONFIRMATION</h2>
                    
                    <div class="confirmation-content">
                        <div class="success-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h3>Thank You for Your Order!</h3>
                        <p>Your order has been successfully placed.</p>

                        <div class="order-summary">
                            <h4>Order Details:</h4>
                            <div id="confirmationDetails"></div>
                        </div>

                        <div class="shipping-info">
                            <h4>Shipping To:</h4>
                            <p id="confirmationShipping"></p>
                        </div>

                        <div class="confirmation-actions">
                            <button type="button" class="continue-btn" onclick="backToHome()">BACK TO HOME</button>
                            <button type="button" class="continue-btn secondary-btn" onclick="downloadReceipt()">DOWNLOAD RECEIPT</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Backdrop -->
    <div id="modalBackdrop" class="modal-backdrop"></div>

    <!-- Fresh Login & Signup Modal -->
    <div id="authModal" class="auth-modal-new">
        <div class="modal-container">
            <!-- Left Side - Illustration -->
            <div class="modal-left-side">
                <img src="{% static 'images/left.png' %}" alt="Farm Illustration" class="modal-illustration">
            </div>

            <!-- Right Side - Form -->
            <div class="modal-right-side">
                <button type="button" class="modal-close-btn" onclick="closeAuthModal()">&times;</button>
                
                <!-- Login Form -->
                <div id="loginForm" class="auth-form-section">
                    <div class="form-header">
                        <h1 class="form-title">Login</h1>
                        <p class="form-subtitle">Welcome back to Farm2Home</p>
                    </div>

                    <form id="loginFormElement" method="POST" action="{% url 'main:login' %}" class="form-container">
                        {% csrf_token %}
                        
                        <!-- Django Messages -->
                        {% if messages %}
                            <div class="messages-box">
                                {% for message in messages %}
                                    <div class="message message-{{ message.tags }}">
                                        <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %}"></i>
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="login_email">Email Address</label>
                            <div class="input-field">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="login_email" name="email" placeholder="your@email.com" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="login_password">Password</label>
                            <div class="input-field password-field">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="login_password" name="password" placeholder="Enter your password" required>
                                <button type="button" class="toggle-password" onclick="togglePassword('login_password')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-row">
                            <label class="checkbox-field">
                                <input type="checkbox" name="rememberMe">
                                <span>Remember me</span>
                            </label>
                            <button type="button" class="forgot-password-link" onclick="switchToForgotPassword()">Forgot password?</button>
                        </div>

                        <button type="submit" class="submit-btn">Login</button>
                    </form>

                    <div class="form-footer">
                        <p>Don't have an account? <button type="button" class="switch-form-btn" onclick="switchToSignup()">Sign up</button></p>
                    </div>
                </div>

                <!-- Signup Form (Hidden by default) -->
                <div id="signupForm" class="auth-form-section" style="display: none;">
                    <div class="form-header">
                        <h1 class="form-title">Sign Up</h1>
                        <p class="form-subtitle">Create your Farm2Home account</p>
                    </div>

                    <form id="signupFormElement" method="POST" action="{% url 'main:signup' %}" class="form-container">
                        {% csrf_token %}
                        
                        <!-- Django Messages -->
                        {% if messages %}
                            <div class="messages-box">
                                {% for message in messages %}
                                    <div class="message message-{{ message.tags }}">
                                        <i class="fas fa-{% if message.tags == 'error' %}exclamation-circle{% elif message.tags == 'success' %}check-circle{% else %}info-circle{% endif %}"></i>
                                        {{ message }}
                                    </div>
                                {% endfor %}
                            </div>
                        {% endif %}

                        <div class="form-group">
                            <label for="signup_fullname">Full Name</label>
                            <div class="input-field">
                                <i class="fas fa-user"></i>
                                <input type="text" id="signup_fullname" name="fullName" placeholder="John Doe" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="signup_email">Email Address</label>
                            <div class="input-field">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="signup_email" name="email" placeholder="your@email.com" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="signup_phone">Phone Number</label>
                            <div class="input-field">
                                <i class="fas fa-phone"></i>
                                <input type="tel" id="signup_phone" name="phone" placeholder="+92 300 1234567" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="signup_address">Address</label>
                            <div class="input-field">
                                <i class="fas fa-map-marker-alt"></i>
                                <input type="text" id="signup_address" name="address" placeholder="123 Street, City" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="signup_password">Password</label>
                            <div class="input-field password-field">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="signup_password" name="password" placeholder="Create a strong password" required>
                                <button type="button" class="toggle-password" onclick="togglePassword('signup_password')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="signup_confirm_password">Confirm Password</label>
                            <div class="input-field password-field">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="signup_confirm_password" name="confirmPassword" placeholder="Confirm your password" required>
                                <button type="button" class="toggle-password" onclick="togglePassword('signup_confirm_password')">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                        </div>

                        <label class="checkbox-field">
                            <input type="checkbox" name="agreeTerms" required>
                            <span>I agree to the Terms & Conditions</span>
                        </label>

                        <button type="submit" class="submit-btn">Create Account</button>
                    </form>

                    <div class="form-footer">
                        <p>Already have an account? <button type="button" class="switch-form-btn" onclick="switchToLogin()">Login</button></p>
                    </div>
                </div>

                <!-- Forgot Password Form (Hidden by default) -->
                <div id="forgotPasswordForm" class="auth-form-section" style="display: none;">
                    <div class="form-header">
                        <button type="button" class="back-btn" onclick="switchToLogin()">
                            <i class="fas fa-arrow-left"></i> Back to Login
                        </button>
                        <h1 class="form-title">Forgot Password?</h1>
                        <p class="form-subtitle">Enter your email to receive a password reset link</p>
                    </div>

                    <form id="forgotPasswordFormElement" class="form-container">
                        {% csrf_token %}
                        
                        <div id="forgotPasswordAlert"></div>

                        <div class="form-group">
                            <label for="forgot_email">Email Address</label>
                            <div class="input-field">
                                <i class="fas fa-envelope"></i>
                                <input type="email" id="forgot_email" name="email" placeholder="your@email.com" required>
                            </div>
                        </div>

                        <button type="submit" class="submit-btn" id="forgotPasswordSubmitBtn">
                            <span id="forgotPasswordBtnText">Send Reset Link</span>
                            <span id="forgotPasswordBtnSpinner" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i> Sending...
                            </span>
                        </button>
                    </form>

                    <div class="form-footer">
                        <p>Remember your password? <button type="button" class="switch-form-btn" onclick="switchToLogin()">Login</button></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // MODAL CONTROL FUNCTIONS
        // ================================

        function openLoginModal() {
            const modal = document.getElementById('authModal');
            const backdrop = document.getElementById('modalBackdrop');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            // Show login form, hide signup form
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            
            // Show modal
            modal.classList.add('active');
            backdrop.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function openSignupModal() {
            const modal = document.getElementById('authModal');
            const backdrop = document.getElementById('modalBackdrop');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            // Show signup form, hide login form
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            
            // Show modal
            modal.classList.add('active');
            backdrop.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAuthModal(event) {
            // If event exists and it's not the backdrop, don't close
            if (event && event.target !== document.getElementById('modalBackdrop')) {
                return;
            }
            
            const modal = document.getElementById('authModal');
            const backdrop = document.getElementById('modalBackdrop');
            
            modal.classList.remove('active');
            backdrop.classList.remove('active');
            document.body.style.overflow = 'auto';
        }

        function switchToLogin() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            
            loginForm.style.display = 'block';
            signupForm.style.display = 'none';
            if (forgotPasswordForm) forgotPasswordForm.style.display = 'none';
        }

        function switchToSignup() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            
            loginForm.style.display = 'none';
            signupForm.style.display = 'block';
            if (forgotPasswordForm) forgotPasswordForm.style.display = 'none';
        }

        function switchToForgotPassword() {
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const forgotPasswordForm = document.getElementById('forgotPasswordForm');
            
            loginForm.style.display = 'none';
            signupForm.style.display = 'none';
            if (forgotPasswordForm) forgotPasswordForm.style.display = 'block';
        }

        function togglePassword(fieldId) {
            const input = document.getElementById(fieldId);
            const button = event.currentTarget;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        // Close modal on backdrop click
        document.getElementById('modalBackdrop').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAuthModal(e);
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('authModal');
                if (modal.classList.contains('active')) {
                    closeAuthModal();
                }
            }
        });

        // ================================
        // AJAX FORM HANDLERS
        // ================================

        // Get CSRF token from cookie
        function getCsrfToken() {
            const name = 'csrftoken';
            const cookieValue = document.cookie.split('; ').find(row => row.startsWith(name + '='));
            return cookieValue ? cookieValue.split('=')[1] : null;
        }

        // Show error message in modal
        function showModalError(message, formType) {
            const form = formType === 'login' ? document.getElementById('loginForm') : document.getElementById('signupForm');
            
            // Remove existing error messages
            const existingError = form.querySelector('.modal-error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Create and insert error message
            const errorDiv = document.createElement('div');
            errorDiv.className = 'modal-error-message';
            errorDiv.style.cssText = 'background: #fee; border: 1px solid #fcc; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-circle"></i><span>${message}</span>`;
            
            const formContainer = form.querySelector('.form-container');
            formContainer.insertBefore(errorDiv, formContainer.firstChild);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 5000);
        }

        // Show success message in modal
        function showModalSuccess(message, formType) {
            const form = formType === 'login' ? document.getElementById('loginForm') : document.getElementById('signupForm');
            
            // Remove existing messages
            const existingMessage = form.querySelector('.modal-success-message');
            if (existingMessage) {
                existingMessage.remove();
            }
            
            // Create and insert success message
            const successDiv = document.createElement('div');
            successDiv.className = 'modal-success-message';
            successDiv.style.cssText = 'background: #efe; border: 1px solid #cfc; color: #3c3; padding: 12px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i><span>${message}</span>`;
            
            const formContainer = form.querySelector('.form-container');
            formContainer.insertBefore(successDiv, formContainer.firstChild);
        }

        // AJAX Login Handler
        document.addEventListener('DOMContentLoaded', function() {
            const loginFormElement = document.getElementById('loginFormElement');
            
            if (loginFormElement) {
                loginFormElement.addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission
                    
                    // Get form values
                    const email = document.getElementById('login_email').value.trim();
                    const password = document.getElementById('login_password').value.trim();
                    
                    // Client-side validation
                    if (!email || !password) {
                        showModalError('Please fill in all fields', 'login');
                        return;
                    }
                    
                    if (!email.includes('@') || !email.includes('.')) {
                        showModalError('Please enter a valid email address', 'login');
                        return;
                    }
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = loginFormElement.querySelector('.submit-btn');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Logging in...';
                    
                    // Prepare data for API
                    const loginData = {
                        email: email,
                        password: password
                    };
                    
                    // Send AJAX request to login API
                    fetch('/api/auth/login/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify(loginData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Login successful
                            showModalSuccess('Login successful! Loading your cart...', 'login');
                            
                            // Save customer data to localStorage
                            localStorage.setItem('customer_id', data.customer_id);
                            localStorage.setItem('customer_name', data.name);
                            localStorage.setItem('customer_email', data.email);
                            
                            // Close modal after short delay and reload cart
                            setTimeout(() => {
                                closeAuthModal();
                                // Reload the page to fetch cart with customer_id
                                window.location.reload();
                            }, 1000);
                        } else {
                            // Login failed
                            showModalError(data.error || 'Login failed. Please try again.', 'login');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Login error:', error);
                        showModalError('Network error. Please check your connection and try again.', 'login');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
                });
            }
        });

        // AJAX Signup Handler
        document.addEventListener('DOMContentLoaded', function() {
            const signupFormElement = document.getElementById('signupFormElement');
            
            if (signupFormElement) {
                signupFormElement.addEventListener('submit', function(e) {
                    e.preventDefault(); // Prevent default form submission
                    
                    // Get form values
                    const fullname = document.getElementById('signup_fullname').value.trim();
                    const email = document.getElementById('signup_email').value.trim();
                    const phone = document.getElementById('signup_phone').value.trim();
                    const address = document.getElementById('signup_address').value.trim();
                    const password = document.getElementById('signup_password').value.trim();
                    const confirmPassword = document.getElementById('signup_confirm_password').value.trim();
                    const agreeTerms = signupFormElement.querySelector('input[name="agreeTerms"]').checked;
                    
                    // Client-side validation
                    if (!fullname || !email || !phone || !address || !password || !confirmPassword) {
                        showModalError('Please fill in all fields', 'signup');
                        return;
                    }
                    
                    if (!email.includes('@') || !email.includes('.')) {
                        showModalError('Please enter a valid email address', 'signup');
                        return;
                    }
                    
                    if (password.length < 6) {
                        showModalError('Password must be at least 6 characters long', 'signup');
                        return;
                    }
                    
                    if (password !== confirmPassword) {
                        showModalError('Passwords do not match', 'signup');
                        return;
                    }
                    
                    if (!agreeTerms) {
                        showModalError('Please agree to the Terms & Conditions', 'signup');
                        return;
                    }
                    
                    // Disable submit button to prevent double submission
                    const submitBtn = signupFormElement.querySelector('.submit-btn');
                    const originalText = submitBtn.textContent;
                    submitBtn.disabled = true;
                    submitBtn.textContent = 'Creating Account...';
                    
                    // Prepare data for API
                    const signupData = {
                        name: fullname,
                        email: email,
                        phone: phone,
                        address: address,
                        password: password
                    };
                    
                    // Send AJAX request to signup API
                    fetch('/api/auth/signup/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCsrfToken()
                        },
                        body: JSON.stringify(signupData)
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Signup successful
                            showModalSuccess('Account created successfully! Logging you in...', 'signup');
                            
                            // Save customer data to localStorage
                            localStorage.setItem('customer_id', data.customer_id);
                            localStorage.setItem('customer_name', data.name);
                            localStorage.setItem('customer_email', data.email);
                            
                            // Close modal after short delay and reload cart
                            setTimeout(() => {
                                closeAuthModal();
                                // Reload the page to fetch cart with customer_id
                                window.location.reload();
                            }, 1500);
                        } else {
                            // Signup failed
                            showModalError(data.error || 'Signup failed. Please try again.', 'signup');
                            submitBtn.disabled = false;
                            submitBtn.textContent = originalText;
                        }
                    })
                    .catch(error => {
                        console.error('Signup error:', error);
                        showModalError('Network error. Please check your connection and try again.', 'signup');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    });
                });
            }

            // Forgot Password form submission
            const forgotPasswordFormElement = document.getElementById('forgotPasswordFormElement');
            if (forgotPasswordFormElement) {
                forgotPasswordFormElement.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const email = document.getElementById('forgot_email').value.trim();
                    const submitBtn = document.getElementById('forgotPasswordSubmitBtn');
                    const btnText = document.getElementById('forgotPasswordBtnText');
                    const btnSpinner = document.getElementById('forgotPasswordBtnSpinner');
                    const alertContainer = document.getElementById('forgotPasswordAlert');
                    
                    if (!email) {
                        showForgotPasswordAlert('Please enter your email address', 'error');
                        return;
                    }
                    
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    if (!emailRegex.test(email)) {
                        showForgotPasswordAlert('Please enter a valid email address', 'error');
                        return;
                    }
                    
                    submitBtn.disabled = true;
                    btnText.style.display = 'none';
                    btnSpinner.style.display = 'inline';
                    
                    try {
                        const response = await fetch('/api/auth/request-password-reset/', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': getCsrfToken()
                            },
                            body: JSON.stringify({ email: email })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            showForgotPasswordAlert(data.message, 'success');
                            forgotPasswordFormElement.reset();
                        } else {
                            showForgotPasswordAlert(data.error || 'Failed to send reset link. Please try again.', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showForgotPasswordAlert('An error occurred. Please try again later.', 'error');
                    } finally {
                        submitBtn.disabled = false;
                        btnText.style.display = 'inline';
                        btnSpinner.style.display = 'none';
                    }
                });
            }
            
            function showForgotPasswordAlert(message, type) {
                const alertContainer = document.getElementById('forgotPasswordAlert');
                const alertClass = type === 'success' ? 'message-success' : 'message-error';
                const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
                
                alertContainer.innerHTML = `
                    <div class="message ${alertClass}">
                        <i class="fas ${icon}"></i>
                        ${message}
                    </div>
                `;
                
                setTimeout(() => {
                    alertContainer.innerHTML = '';
                }, 5000);
            }
        });
    </script>

    <script src="{% static 'js/notifications.js' %}"></script>
    <script src="{% static 'js/checkout.js' %}"></script>
</body>
</html>
